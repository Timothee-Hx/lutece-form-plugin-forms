<#include "/admin/plugins/forms/edit_form_tabs.html" />
<@row>
<@columns>
<@box color='primary'>
<@boxHeader title='${form.title!}' />
<@boxBody>
<@formBreadCrumb><@breadcrumbItem>${form.title!}</@breadcrumbItem></@formBreadCrumb>
<@formTabs tab="export" />
<@box>
<@row>
<@columns sm=2 class='mt-5'>
<@tabList vertical=true>
<@tabLink id='export-1-tab' active=!activeTabPannel2 href='#export-1' title='#i18n{forms.modify_form.export.config.text1}' />
<@tabLink id='export-2-tab' active=activeTabPannel2 href='#export-2' title='#i18n{forms.modify_form.export.config.questions}' />
</@tabList>
</@columns>
<@columns sm=10>
<@tabContent>
<@tabPanel id="export-1" active=!activeTabPannel2 >
<@row>
<@columns sm=9>
<@tform class='form' method='post' name='manage_export' action='jsp/admin/plugins/forms/ManageFormExport.jsp'>
<@input type='hidden' id='token' name='token' value='${token}' />
<@input type='hidden' id='id_form' name='id_form' value='${form.id}' />
<@formGroup labelKey='#i18n{forms.modify_form.labelExportOption}' mandatory=true rows=2 class='has-addons'>
<@inputGroup class=''>
<@select name='export_config' items=export_list default_value='' />
<@inputGroupItem>
<@button type='submit' name='action_createExportConfig' buttonIcon='check' title='#i18n{forms.modifyEntry.buttonSave}' hideTitle=['all'] />
</@inputGroupItem>
</@inputGroup>
</@formGroup>
<@table id='export_config'>
<@tr>
<@th>#i18n{forms.modify_form.labelExportOption}</@th>
<@th>#i18n{forms.modify_form.labelOrder}</@th>
<@th>#i18n{forms.manageForm.columnActions}</@th>
</@tr>
<#list export_config_list as config>
<@tr>
<@td>${config.fieldTitle}</@td>
<@td>${config.order}</@td>
<@td>
<#if export_config_list?size gt 1>
<#if config.order gt 1>
<@aButton href='jsp/admin/plugins/forms/ManageFormExport.jsp?action=doMoveUpExportConfig&id_config=${config.id}&id_form=${form.id}' title='#i18n{forms.modify_form.action.moveUpExportConfig}' hideTitle=['all'] buttonIcon='chevron-up' size='sm' />
</#if>
<#if config.order lt export_config_list?size>
<@aButton href='jsp/admin/plugins/forms/ManageFormExport.jsp?action=doMoveDownExportConfig&id_config=${config.id}&id_form=${form.id}' title='#i18n{forms.modify_form.action.moveDownExportConfig}' hideTitle=['all'] buttonIcon='chevron-down' size='sm' />
</#if>
</#if>
<@aButton href='jsp/admin/plugins/forms/ManageFormExport.jsp?view=confirmRemoveExportConfig&id_config=${config.id}&id_form=${form.id}' title='#i18n{forms.modify_form.action.removeExportConfig}' hideTitle=['all'] buttonIcon='trash' color='danger' size='sm' />
</@td>
</@tr>
</#list>
</@table>
</@tform>
</@columns>
<@columns sm=3>
<@callOut color='warning' title='#i18n{forms.modify_form.export.config.text2}' titleLevel='strong' callOutIcon='exclamation' />
</@columns>
</@row>
</@tabPanel>





<@tabPanel id='export-2' active=activeTabPannel2 >

<@tform class='form' method='post' name='manage_export' action='jsp/admin/plugins/forms/ManageFormExport.jsp'>
<@input type='hidden' id='token' name='token' value='${token}' />
<@input type='hidden' id='id_form' name='id_form' value='${form.id}' />
<@table id='list' headBody=true  class='table-striped is-fullwidth' params=' data-toggle="table" data-group-by="true" data-group-by-field="step" data-search="true" data-show-columns="true"'>
<@tr>
<@th params='data-field="step"'>#i18n{forms.manage_question_response.step}</@th>
<@th params='data-field="title"'>#i18n{forms.manage_question_response.columnTitle}</@th>
<@th params='data-sortable="true" data-field="status"'>#i18n{forms.createEntry.labelResponsesExportable}</@th>
<@th params='data-sortable="true" data-field="status"'>#i18n{forms.createEntry.labelResponsesExportablePdf}</@th>
<@th>#i18n{forms.manage_question_response.order}</@th>
</@tr>

<@tableHeadBodySeparator />

<#list questionList?sort_by('exportDisplayOrder') as question>
<@tr>
<@td>${question.step.title!}</@td>
<@td>${question.title!}</@td>
<@td>
<@formGroup labelFor='exportable' labelKey='forms.createEntry.labelResponsesExportable' labelClass='text-white'>
<@checkBox orientation='switch' name='exportable' id='exportable_${question.id}' value='${question.id}' checked=(question?has_content && question.entry.exportable!) />
</@formGroup>
</@td>
<@td>
<@formGroup labelFor='exportablePdf' labelKey='forms.createEntry.labelResponsesExportablePdf' labelClass='text-white'>
<@checkBox orientation='switch' name='exportablePdf' id='exportablePdf_${question.id}' value='${question.id}' checked=(question?has_content && question.entry.exportablePdf!) />
</@formGroup>
</@td>
<@td>
<@input type='hidden' name='id_question_${question.id}' value='${question.id}' />
<@formGroup>
<@inputGroup>
<@comboOrders name='export_display_order_${question.id}' default_value=question.exportDisplayOrder max=number_max_order />

<@inputGroupItem>
<@aButton href='jsp/admin/plugins/forms/ManageOrderExportableQuestion.jsp?actionName=doChangeOrderExportableQuestion&id_question=${question.id}&export_display_order_${question.id}'
buttonIcon='check' color='default' hideTitle=['all'] size='sm' />
</@inputGroupItem>

</@inputGroup>
</@formGroup>
</@td>
</@tr>
</#list>
</@table>
<@formGroup rows=2>
<@headerButton name='action_modifyExportableQuestions' label='forms.modify_form.buttonValidate' />
</@formGroup>
</@tform>
</@tabPanel>
</@tabContent>
</@columns>
</@row>
</@box>
</@boxBody>
</@box>
</@columns>

</@row>
<!--
<script defer>
	let questionsIdAndDisplayOrder = '${questionsIdAndDisplayOrder}';
	// parse the json string into an array of objects
	questionsIdAndDisplayOrder = JSON.parse(questionsIdAndDisplayOrder);
	console.log(questionsIdAndDisplayOrder)
	questionsIdAndDisplayOrder.sort(function(a, b) {
		return a.exportDisplayOrder - b.exportDisplayOrder;
	});
	console.log(questionsIdAndDisplayOrder)
	const number_max_order = questionsIdAndDisplayOrder.length;


	function assignNewOrder (id_question, new_order) {
		let InputIdToReAssign ="";
		let valueToReAssign ;
		let arrayOrder = [];
		for (let i = 0; i < questionsIdAndDisplayOrder.length; i++) {
			let orderValue = document.getElementById("export_display_order_" + questionsIdAndDisplayOrder[i].id).value;
			arrayOrder.push(orderValue);
			if (orderValue === new_order && document.getElementById("export_display_order_" + questionsIdAndDisplayOrder[i].id).id !== id_question) {
				InputIdToReAssign = document.getElementById("export_display_order_" + questionsIdAndDisplayOrder[i].id).id
			}
		}
		for (let i = 1; i < questionsIdAndDisplayOrder.length+1; i++) {
			if (!arrayOrder.includes(i.toString())) {
				valueToReAssign = i;
			}
		}
		document.getElementById(InputIdToReAssign).value = valueToReAssign;
	}
	for (i = 0; i < questionsIdAndDisplayOrder.length; ++i) {
		let tr = document.createElement('tr');
		tr.id = "question_"+questionsIdAndDisplayOrder[i].id;
		let td = document.createElement('td');
		td.innerText = questionsIdAndDisplayOrder[i].stepTitle;
		let td2 = document.createElement('td');
		td2.innerText = questionsIdAndDisplayOrder[i].title;
		let td3 = document.createElement('td');
        let label = document.createElement('label');
        label.className = "form-check form-switch";
        label.htmlFor = "exportable_"+questionsIdAndDisplayOrder[i].id;
		let checkBox = document.createElement('input');
		checkBox.type = "checkbox";
		checkBox.name = "exportable";
        checkBox.className = "form-check-input"
        checkBox.id = "exportable_"+questionsIdAndDisplayOrder[i].id;
		checkBox.value = questionsIdAndDisplayOrder[i].id;
		checkBox.checked = questionsIdAndDisplayOrder[i].exportable;
        let span = document.createElement('span');
        span.className = "form-check-label"
        label.appendChild(checkBox);
        label.appendChild(span);
        td3.appendChild(label);
        // create a checkbox
		let td4 = document.createElement('td');
        let label2 = document.createElement('label');
        label2.className = "form-check form-switch";
        label2.htmlFor = "exportablePdf_"+questionsIdAndDisplayOrder[i].id;
        let checkBox2 = document.createElement('input');
		checkBox2.type = "checkbox";
		checkBox2.name = "exportablePdf";
        checkBox2.className = "form-check-input";
		checkBox2.id = "exportablePdf_"+questionsIdAndDisplayOrder[i].id;
		checkBox2.value = questionsIdAndDisplayOrder[i].id;
		checkBox2.checked = questionsIdAndDisplayOrder[i].exportablePdf;
		label2.appendChild(checkBox2);
        label2.appendChild(span);
        td4.appendChild(label2);
		let td5 = document.createElement('td');
		let input = document.createElement('input');
		input.type = "number";
		input.name = "id_question_"+questionsIdAndDisplayOrder[i].id;
		input.value = questionsIdAndDisplayOrder[i].exportDisplayOrder;
		input.min = "1";
		input.max = number_max_order;
        input.onkeydown = function(e) {
                return false;
        };
		input.id = "export_display_order_"+questionsIdAndDisplayOrder[i].id;
		input.onchange = function () {
			assignNewOrder(this.id, this.value);
		};
	    td5.appendChild(input);
		tr.appendChild(td);
		tr.appendChild(td2);
		tr.appendChild(td3);
		tr.appendChild(td4);
		tr.appendChild(td5);
		document.getElementById("questionsTableInputs").appendChild(tr);
	}
</script>
-->